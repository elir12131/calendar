# --- START OF FILE import2csv.py ---

import csv
from datetime import datetime, timedelta
import collections
import re

def to_hebrew_numeral(n):
    if not isinstance(n, int) or not 1 <= n <= 30: return str(n)
    m = {1:"א׳",2:"ב׳",3:"ג׳",4:"ד׳",5:"ה׳",6:"ו׳",7:"ז׳",8:"ח׳",9:"ט׳",10:"י׳",11:"י״א",12:"י״ב",13:"י״ג",14:"י״ד",15:"ט״ו",16:"ט״ז",17:"י״ז",18:"י״ח",19:"י״ט",20:"כ׳",21:"כ״א",22:"כ״ב",23:"כ״ג",24:"כ״ד",25:"כ״ה",26:"כ״ו",27:"כ״ז",28:"כ״ח",29:"כ״ט",30:"ל׳"}
    return m.get(n, str(n))

hebrew_to_english_month_map_global = {"תשרי":"Tishrei","חשון":"Cheshvan","כסלו":"Kislev","טבת":"Teves","שבט":"Sh’vat","אדר":"Adar","אדר א׳":"Adar I","אדר ב׳":"Adar II","ניסן":"Nisan","אייר":"Iyar","סיון":"Sivan","תמוז":"Tamuz","אב":"Av","אלול":"Elul"}
english_to_hebrew_month_map_global = {v: k for k, v in hebrew_to_english_month_map_global.items()}
if "Adar" not in english_to_hebrew_month_map_global: english_to_hebrew_month_map_global["Adar"] = "אדר"

MAJOR_HOLIDAY_KEYWORDS = [
    "Rosh Hashana","Yom Kippur","Sukkos","Sukkot","Simchas Torah","Shmini Atzeres",
    "Pesach","Passover","Shavuos","Shavuot","Chanukah","Hanukkah","Purim",
    "Erev Rosh Hashana","Erev Yom Kippur","Erev Sukkos","Erev Pesach","Erev Shavuos",
    "Tzom Gedaliah","Asara B’Teves","Ta’anis Esther","Tzom Tammuz","Tish’a B’Av",
    "Rosh Chodesh" 
]
FAST_DAY_KEYWORDS = [
    "Tzom Gedaliah","Asara B’Teves","Ta’anis Esther","Tzom Tammuz","Tish’a B’Av",
    "Fast begins", "Fast ends"
]
SPECIAL_SHABBOS_NAMES = [ 
    "Shabbos Shuvah", "Shabbos Shekalim", "Shabbos Zachor", "Shabbos Parah", 
    "Shabbos HaChodesh", "Shabbos HaGadol", "Shabbos Nachamu", "Shabbos Chazon"
]

english_to_hebrew_parsha_map = {
    "Bereshis":"בְּרֵאשִׁית","Noach":"נֹחַ","Lech-Lecha":"לֶךְ-לְךָ","Vayera":"וַיֵּרָא",
    "Chayei Sara":"חַיֵּי שָׂרָה","Toldos":"תּוֹלְדֹת","Vayetzei":"וַיֵּצֵא","Vayishlach":"וַיִּשְׁלַח",
    "Vayeshev":"וַיֵּשֶׁב","Miketz":"מִקֵּץ","Vayigash":"וַיִּגַּשׁ","Vayechi":"וַיְחִי",
    "Shemos":"שְׁמוֹת","Vaera":"וָאֵרָא","Bo":"בֹּא","Beshalach":"בְּשַׁלַּח",
    "Yisro":"יִתְרוֹ","Mishpatim":"מִשְׁפָּטִים","Terumah":"תְּרוּמָה","Tetzaveh":"תְּצַוֶּה",
    "Ki Sisa":"כִּי תִשָּׂא","Vayakhel":"וַיַּקְהֵל","Pekudei":"פְקוּדֵי","Vayakhel-Pekudei":"וַיַּקְהֵל-פְקוּדֵי",
    "Vayikra":"וַיִּקְרָא","Tzav":"צַו","Shmini":"שְׁמִינִי","Tazria":"תַזְרִיעַ",
    "Metzora":"מְצֹרָע","Tazria-Metzora":"תַזְרִיעַ-מְצֹרָע","Achrei Mos":"אַחֲרֵי מוֹת","Kedoshim":"קְדֹשִׁים",
    "Achrei Mos-Kedoshim":"אַחֲרֵי מוֹת-קְדֹשִׁים","Emor":"אֱמֹר","Behar":"בְּהַר","Bechukosai":"בְּחֻקֹּתַי",
    "Behar-Bechukosai":"בְּהַר-בְּחֻקֹּתַי","Bamidbar":"בְּמִדְבַּר","Nasso":"נָשֹׂא",
    "Beha’aloscha":"בְּהַעֲלֹתְךָ", "Beha'aloscha":"בְּהַעֲלֹתְךָ",
    "Sh’lach":"שְׁלַח-לְךָ", "Sh'lach":"שְׁלַח-לְךָ",
    "Korach":"קֹרַח","Chukas":"חֻקַּת","Balak":"בָּלָק","Chukas-Balak":"חֻקַּת-בָּלָק",
    "Pinchas":"פִּינְחָס","Matos":"מַּטּוֹת","Masei":"מַסְעֵי","Matos-Masei":"מַּטּוֹת-מַסְעֵי",
    "Devarim":"דְּבָרִים","Vaeschanan":"וָאֶתְחַנַּן","Eikev":"עֵקֶב","Re’eh":"רְאֵה", "Re'eh":"רְאֵה",
    "Shoftim":"שֹׁפְטִים","Ki Seitzei":"כִּי-תֵצֵא","Ki Savo":"כִּי-תָבוֹא","Nitzavim":"נִצָּבִים",
    "Vayeilech":"וַיֵּלֶךְ","Nitzavim-Vayeilech":"נִצָּבִים-וַיֵּלֶךְ",
    "Ha’azinu":"הַאֲזִינוּ", "Ha'azinu":"הַאֲזִינוּ",
    "V’Zos HaBerachah":"וְזֹאת הַבְּרָכָה"
}

def get_ordinal_suffix(n_str_or_int):
    try: n = int(n_str_or_int)
    except ValueError: return "" 
    if 10 <= n % 100 <= 20: return 'th'
    return {1: 'st', 2: 'nd', 3: 'rd'}.get(n % 10, 'th')

def format_holiday_name(subject):
    original_subject = subject 
    subject_lower = subject.lower()
    if "sukkos vii (hoshana raba)" in subject_lower or "sukkos vii (hoshana rabbah)" in subject_lower:
        return "Hoshana Raba"
    chm_match = re.search(r"(Sukkos|Pesach)\s+([IVXLCDM]+)\s*\(CH’’M\)", subject, re.IGNORECASE)
    if chm_match:
        holiday_name_chm = chm_match.group(1)
        roman_numeral = chm_match.group(2).upper()
        day_map_roman_to_int = {"I":1, "II":2, "III":3, "IV":4, "V":5, "VI":6, "VII":7, "VIII":8}
        day_of_holiday = day_map_roman_to_int.get(roman_numeral)
        if day_of_holiday:
            chm_day_num = 0
            if holiday_name_chm.lower() == "sukkos":
                if day_of_holiday > 2: chm_day_num = day_of_holiday - 2
            elif holiday_name_chm.lower() == "pesach":
                if day_of_holiday > 2: chm_day_num = day_of_holiday - 2 
            if chm_day_num > 0:
                return f"{chm_day_num}{get_ordinal_suffix(chm_day_num)} Day Chol Hamoed"
        return original_subject 
    general_match = re.search(r"^(.*?)\s+([IVXLCDM]+)$", subject)
    if general_match:
        holiday_base_name = general_match.group(1).strip()
        roman_numeral = general_match.group(2).upper()
        day_map_roman_to_int = {"I":1, "II":2, "III":3, "IV":4, "V":5, "VI":6, "VII":7, "VIII":8}
        day_number = day_map_roman_to_int.get(roman_numeral)
        if day_number:
            if holiday_base_name.lower() == "rosh hashana" and day_number == 2:
                return "2nd Day Rosh Hashana"
            if ":" in holiday_base_name: return original_subject
            return f"{day_number}{get_ordinal_suffix(day_number)} Day of {holiday_base_name}"
    return original_subject

hardcoded_cl_hav_data_raw_tuples = [
    # NY (Brooklyn)
    ("Sep", 5, 2025, "Ki Seitzei", "7:02", "8:01", "NY"), ("Sep", 12, 2025, "Ki Savo", "6:51", "7:48", "NY"),
    ("Sep", 19, 2025, "Nitzavim", "6:39", "7:36", "NY"),
    ("Sep", 22, 2025, "Rosh Hashana", "6:34", None, "NY"), ("Sep", 23, 2025, "Rosh Hashana", "7:31", "7:30", "NY"),
    ("Sep", 25, 2025, "Fast Tzom Gedaliah NY", None, "7:20 PM", "NY", "5:25 AM"), 
    ("Sep", 26, 2025, "Vayeilech", "6:27", "7:24", "NY"), ("Oct", 1, 2025, "Yom Kippur", "6:19", "7:16", "NY"),
    ("Oct", 3, 2025, "Ha'azinu", "6:16", "7:13", "NY"), ("Oct", 6, 2025, "Sukkos", "6:11", None, "NY"),
    ("Oct", 7, 2025, "Sukkos", "7:08", "7:06", "NY"), ("Oct", 10, 2025, "Sukkos", "6:04", "7:02", "NY"),
    ("Oct", 13, 2025, "Shmini Atzeres", "6:00", None, "NY"), ("Oct", 14, 2025, "Simchas Torah", "6:57", "6:56", "NY"),
    ("Oct", 17, 2025, "Bereshis", "5:54", "6:52", "NY"), ("Oct", 24, 2025, "Noach", "5:44", "6:42", "NY"),
    ("Oct", 31, 2025, "Lech-Lecha", "5:34", "6:34", "NY"), ("Nov", 7, 2025, "Vayera", "4:27", "5:27", "NY"),
    ("Nov", 14, 2025, "Chayei Sara", "4:20", "5:21", "NY"), ("Nov", 21, 2025, "Toldos", "4:15", "5:17", "NY"),
    ("Nov", 28, 2025, "Vayetzei", "4:12", "5:14", "NY"), ("Dec", 5, 2025, "Vayishlach", "4:10", "5:13", "NY"),
    ("Dec", 12, 2025, "Vayeshev", "4:10", "5:14", "NY"), ("Dec", 19, 2025, "Miketz", "4:12", "5:17", "NY"),
    ("Dec", 26, 2025, "Vayigash", "4:16", "5:21", "NY"),
    ("Dec", 30, 2025, "Fast Asara B'Teves NY", None, "5:15 PM", "NY", "5:51 AM"),
    ("Jan", 2, 2026, "Vayechi", "4:22", "5:26", "NY"), ("Jan", 9, 2026, "Shemos", "4:28", "5:33", "NY"), 
    ("Jan", 16, 2026, "Vaera", "4:36", "5:40", "NY"), ("Jan", 23, 2026, "Bo", "4:44", "5:47", "NY"), 
    ("Jan", 30, 2026, "Beshalach", "4:53", "5:55", "NY"), ("Feb", 6, 2026, "Yisro", "5:01", "6:03", "NY"), 
    ("Feb", 13, 2026, "Mishpatim", "5:10", "6:11", "NY"), ("Feb", 20, 2026, "Terumah", "5:18", "6:19", "NY"), 
    ("Feb", 27, 2026, "Tetzaveh", "5:26", "6:27", "NY"), 
    ("Mar", 2, 2026, "Fast Taanis Esther NY", None, "6:21 PM", "NY", "5:07 AM"),
    ("Mar", 6, 2026, "Ki Sisa", "5:34", "6:34", "NY"), ("Mar", 13, 2026, "Vayakhel-Pekudei", "6:42", "7:42", "NY"),
    ("Mar", 20, 2026, "Vayikra", "6:49", "7:50", "NY"), ("Mar", 27, 2026, "Tzav", "6:57", "7:57", "NY"),
    ("Apr", 1, 2026, "Fast Taanis Bechoros NY", None, None, "NY", "5:16 AM"),
    ("Apr", 1, 2026, "Pesach", "7:02", None, "NY"), ("Apr", 2, 2026, "Pesach", "8:03", None, "NY"),
    ("Apr", 3, 2026, "Pesach", "7:04", "8:05", "NY"), ("Apr", 7, 2026, "Pesach", "7:08", None, "NY"),
    ("Apr", 8, 2026, "Pesach", "8:10", "8:11", "NY"), ("Apr", 10, 2026, "Shmini", "7:11", "8:13", "NY"),
    ("Apr", 17, 2026, "Tazria-Metzora", "7:19", "8:21", "NY"), ("Apr", 24, 2026, "Achrei Mos-Kedoshim", "7:26", "8:29", "NY"),
    ("May", 1, 2026, "Emor", "7:33", "8:38", "NY"), ("May", 8, 2026, "Behar-Bechukosai", "7:41", "8:46", "NY"),
    ("May", 15, 2026, "Bamidbar", "7:48", "8:54", "NY"), ("May", 21, 2026, "Shavuos", "7:53", None, "NY"),
    ("May", 22, 2026, "Shavuos", "7:54", "9:02", "NY"), ("May", 29, 2026, "Nasso", "8:00", "9:08", "NY"),
    ("Jun", 5, 2026, "Beha'aloscha", "8:05", "9:14", "NY"), ("Jun", 12, 2026, "Sh'lach", "8:09", "9:18", "NY"),
    ("Jun", 19, 2026, "Korach", "8:11", "9:21", "NY"), ("Jun", 26, 2026, "Chukas-Balak", "8:12", "9:21", "NY"),
    ("Jul", 2, 2026, "Fast Tzom Tammuz NY", None, "9:11 PM", "NY", "3:41 AM"),
    ("Jul", 3, 2026, "Pinchas", "8:12", "9:20", "NY"), ("Jul", 10, 2026, "Matos-Masei", "8:10", "9:17", "NY"),
    ("Jul", 17, 2026, "Devarim", "8:06", "9:12", "NY"), 
    ("Jul", 22, 2026, "Fast Tisha B'Av NY Start", None, None, "NY", "8:21 PM"), 
    ("Jul", 23, 2026, "Fast Tisha B'Av NY End", None, "8:58 PM", "NY"),       
    ("Jul", 24, 2026, "Vaeschanan", "8:00", "9:05", "NY"), ("Jul", 31, 2026, "Eikev", "7:54", "8:57", "NY"),
    ("Aug", 7, 2026, "Re'eh", "7:46", "8:48", "NY"), ("Aug", 14, 2026, "Shoftim", "7:36", "8:37", "NY"),
    ("Aug", 21, 2026, "Ki Seitzei", "7:26", "8:26", "NY"), ("Aug", 28, 2026, "Ki Savo", "7:16", "8:15", "NY"),
    # AZ
    ("Sep", 5, 2025, "Ki Seitzei", "6:29", "7:24", "AZ"),("Sep",12,2025,"Ki Savo","6:20","7:14","AZ"),("Sep",19,2025,"Nitzavim","6:10","7:04","AZ"),
    ("Sep",22,2025,"Rosh Hashana","6:06",None,"AZ"),("Sep",23,2025,"Rosh Hashana","7:00","6:58","AZ"),
    ("Sep",25,2025,"Fast Tzom Gedaliah AZ",None,"6:50 PM","AZ","5:05 AM"),
    ("Sep",26,2025,"Vayeilech","6:00","6:54","AZ"),("Oct",1,2025,"Yom Kippur","5:54","6:48","AZ"),
    ("Oct",3,2025,"Ha'azinu","5:51","6:45","AZ"),("Oct",6,2025,"Sukkos","5:47",None,"AZ"),
    ("Oct",7,2025,"Sukkos","6:41","6:40","AZ"),("Oct",10,2025,"Sukkos","5:42","6:36","AZ"),("Oct",13,2025,"Shmini Atzeres","5:38",None,"AZ"),
    ("Oct",14,2025,"Simchas Torah","6:32","6:31","AZ"),("Oct",17,2025,"Bereshis","5:33","6:28","AZ"),("Oct",24,2025,"Noach","5:25","6:20","AZ"),
    ("Oct",31,2025,"Lech-Lecha","5:18","6:14","AZ"),("Nov",7,2025,"Vayera","5:12","6:09","AZ"),("Nov",14,2025,"Chayei Sara","5:08","6:04","AZ"),
    ("Nov",21,2025,"Toldos","5:04","6:02","AZ"),("Nov",28,2025,"Vayetzei","5:02","6:00","AZ"),("Dec",5,2025,"Vayishlach","5:02","6:01","AZ"),
    ("Dec",12,2025,"Vayeshev","5:03","6:02","AZ"),("Dec",19,2025,"Miketz","5:05","6:05","AZ"),("Dec",26,2025,"Vayigash","5:09","6:09","AZ"),
    ("Dec",30,2025,"Fast Asara B'Teves AZ",None,"6:03 PM","AZ","6:13 AM"),
    ("Jan",2,2026,"Vayechi","5:14","6:14","AZ"),("Jan",9,2026,"Shemos","5:20","6:19","AZ"),("Jan",16,2026,"Vaera","5:26","6:25","AZ"),
    ("Jan",23,2026,"Bo","5:33","6:31","AZ"),("Jan",30,2026,"Beshalach","5:40","6:38","AZ"),("Feb",6,2026,"Yisro","5:46","6:44","AZ"),
    ("Feb",13,2026,"Mishpatim","5:53","6:50","AZ"),("Feb",20,2026,"Terumah","5:59","6:56","AZ"),("Feb",27,2026,"Tetzaveh","6:05","7:01","AZ"),
    ("Mar",2,2026,"Fast Taanis Esther AZ",None,"6:56 PM","AZ","5:42 AM"),
    ("Mar",6,2026,"Ki Sisa","6:11","7:07","AZ"),("Mar",13,2026,"Vayakhel-Pekudei","6:16","7:12","AZ"),("Mar",20,2026,"Vayikra","6:22","7:18","AZ"),
    ("Mar",27,2026,"Tzav","6:27","7:23","AZ"),
    ("Apr",1,2026,"Fast Taanis Bechoros AZ",None,None,"AZ","5:01 AM"),
    ("Apr",1,2026,"Pesach","6:30",None,"AZ"),("Apr",2,2026,"Pesach","7:27",None,"AZ"),
    ("Apr",3,2026,"Pesach","6:32","7:29","AZ"),("Apr",7,2026,"Pesach","6:35",None,"AZ"),("Apr",8,2026,"Pesach","7:32","7:33","AZ"),
    ("Apr",10,2026,"Shmini","6:37","7:34","AZ"),("Apr",17,2026,"Tazria-Metzora","6:42","7:40","AZ"),("Apr",24,2026,"Achrei Mos-Kedoshim","6:48","7:46","AZ"),
    ("May",1,2026,"Emor","6:53","7:52","AZ"),("May",8,2026,"Behar-Bechukosai","6:58","7:58","AZ"),("May",15,2026,"Bamidbar","7:03","8:04","AZ"),
    ("May",21,2026,"Shavuos","7:08",None,"AZ"),("May",22,2026,"Shavuos","7:08","8:09","AZ"),("May",29,2026,"Nasso","7:13","8:15","AZ"),
    ("Jun",5,2026,"Beha'aloscha","7:17","8:19","AZ"),("Jun",12,2026,"Sh'lach","7:20","8:22","AZ"),("Jun",19,2026,"Korach","7:22","8:25","AZ"),
    ("Jun",26,2026,"Chukas-Balak","7:24","8:26","AZ"),
    ("Jul",2,2026,"Fast Tzom Tammuz AZ",None,"8:17 PM","AZ","3:53 AM"),
    ("Jul",3,2026,"Pinchas","7:23","8:25","AZ"),("Jul",10,2026,"Matos-Masei","7:22","8:23","AZ"),
    ("Jul",17,2026,"Devarim","7:19","8:19","AZ"),
    ("Jul",22,2026,"Fast Tisha B'Av AZ Start",None,None,"AZ","7:35 PM"), 
    ("Jul",23,2026,"Fast Tisha B'Av AZ End",None,"8:08 PM","AZ"),      
    ("Jul",24,2026,"Vaeschanan","7:15","8:14","AZ"),("Jul",31,2026,"Eikev","7:10","8:08","AZ"),
    ("Aug",7,2026,"Re'eh","7:04","8:01","AZ"),("Aug",14,2026,"Shoftim","6:57","7:53","AZ"),("Aug",21,2026,"Ki Seitzei","6:49","7:44","AZ"),
    ("Aug",28,2026,"Ki Savo","6:40","7:35","AZ"),
    # PA
    ("Sep",5,2025,"Ki Seitzei","7:11","8:09","PA"),("Sep",12,2025,"Ki Savo","6:59","7:57","PA"),("Sep",19,2025,"Nitzavim","6:47","7:45","PA"),
    ("Sep",22,2025,"Rosh Hashana","6:42",None,"PA"),("Sep",23,2025,"Rosh Hashana","7:39","7:38","PA"),
    ("Sep",25,2025,"Fast Tzom Gedaliah PA",None,"7:28 PM","PA","5:32 AM"),
    ("Sep",26,2025,"Vayeilech","6:35","7:32","PA"),("Oct",1,2025,"Yom Kippur","6:26","7:24","PA"),
    ("Oct",3,2025,"Ha’azinu","6:23","7:21","PA"),("Oct",6,2025,"Sukkos","6:18",None,"PA"),
    ("Oct",7,2025,"Sukkos","7:16","7:14","PA"),("Oct",10,2025,"Sukkos","6:12","7:09","PA"),("Oct",13,2025,"Shmini Atzeres","6:07",None,"PA"),
    ("Oct",14,2025,"Simchas Torah","7:05","7:03","PA"),("Oct",17,2025,"Bereshis","6:01","6:59","PA"),("Oct",24,2025,"Noach","5:50","6:49","PA"),
    ("Oct",31,2025,"Lech-Lecha","5:41","6:41","PA"),("Nov",7,2025,"Vayera","4:33","5:34","PA"),("Nov",14,2025,"Chayei Sara","4:26","5:28","PA"),
    ("Nov",21,2025,"Toldos","4:21","5:23","PA"),("Nov",28,2025,"Vayetzei","4:18","5:21","PA"),("Dec",5,2025,"Vayishlach","4:16","5:20","PA"),
    ("Dec",12,2025,"Vayeshev","4:16","5:21","PA"),("Dec",19,2025,"Miketz","4:18","5:23","PA"),("Dec",26,2025,"Vayigash","4:22","5:27","PA"),
    ("Dec",30,2025,"Fast Asara B'Teves PA",None,"5:21 PM","PA","6:00 AM"),
    ("Jan",2,2026,"Vayechi","4:28","5:33","PA"),("Jan",9,2026,"Shemos","4:34","5:39","PA"),("Jan",16,2026,"Vaera","4:42","5:46","PA"),
    ("Jan",23,2026,"Bo","4:50","5:54","PA"),("Jan",30,2026,"Beshalach","4:59","6:02","PA"),("Feb",6,2026,"Yisro","5:08","6:10","PA"),
    ("Feb",13,2026,"Mishpatim","5:17","6:18","PA"),("Feb",20,2026,"Terumah","5:25","6:26","PA"),("Feb",27,2026,"Tetzaveh","5:34","6:34","PA"),
    ("Mar",2,2026,"Fast Taanis Esther PA",None,"6:29 PM","PA","5:15 AM"),
    ("Mar",6,2026,"Ki Sisa","5:42","6:42","PA"),("Mar",13,2026,"Vayakhel-Pekudei","6:50","7:50","PA"),("Mar",20,2026,"Vayikra","6:57","7:58","PA"),
    ("Mar",27,2026,"Tzav","7:05","8:06","PA"),
    ("Apr",1,2026,"Fast Taanis Bechoros PA",None,None,"PA","5:23 AM"),
    ("Apr",1,2026,"Pesach","7:10",None,"PA"),("Apr",2,2026,"Pesach","8:12",None,"PA"),
    ("Apr",3,2026,"Pesach","7:12","8:14","PA"),("Apr",7,2026,"Pesach","7:17",None,"PA"),("Apr",8,2026,"Pesach","8:18","8:20","PA"),
    ("Apr",10,2026,"Shmini","7:20","8:22","PA"),("Apr",17,2026,"Tazria-Metzora","7:27","8:30","PA"),("Apr",24,2026,"Achrei Mos-Kedoshim","7:35","8:39","PA"),
    ("May",1,2026,"Emor","7:43","8:47","PA"),("May",8,2026,"Behar-Bechukosai","7:50","8:56","PA"),("May",15,2026,"Bamidbar","7:57","9:04","PA"),
    ("May",21,2026,"Shavuos","8:03",None,"PA"),("May",22,2026,"Shavuos","8:04","9:12","PA"),("May",29,2026,"Nasso","8:10","9:19","PA"),
    ("Jun",5,2026,"Beha’aloscha","8:15","9:24","PA"),("Jun",12,2026,"Sh’lach","8:19","9:29","PA"),("Jun",19,2026,"Korach","8:21","9:31","PA"),
    ("Jun",26,2026,"Chukas-Balak","8:22","9:32","PA"),
    ("Jul",2,2026,"Fast Tzom Tammuz PA",None,"9:21 PM","PA","3:45 AM"),
    ("Jul",3,2026,"Pinchas","8:22","9:31","PA"),("Jul",10,2026,"Matos-Masei","8:19","9:27","PA"),
    ("Jul",17,2026,"Devarim","8:15","9:22","PA"),
    ("Jul",22,2026,"Fast Tisha B'Av PA Start",None,None,"PA","8:30 PM"),
    ("Jul",23,2026,"Fast Tisha B'Av PA End",None,"9:08 PM","PA"),
    ("Jul",24,2026,"Vaeschanan","8:10","9:15","PA"),("Jul",31,2026,"Eikev","8:03","9:07","PA"),
    ("Aug",7,2026,"Re’eh","7:55","8:57","PA"),("Aug",14,2026,"Shoftim","7:45","8:47","PA"),("Aug",21,2026,"Ki Seitzei","7:35","8:35","PA"),
    ("Aug",28,2026,"Ki Savo","7:24","8:24","PA"),
    # NH
    ("Sep",5,2025,"Ki Seitzei","6:59","7:58","NH"),("Sep",12,2025,"Ki Savo","6:47","7:45","NH"),("Sep",19,2025,"Nitzavim","6:35","7:33","NH"),
    ("Sep",22,2025,"Rosh Hashana","6:30",None,"NH"),("Sep",23,2025,"Rosh Hashana","7:28","7:26","NH"),
    ("Sep",25,2025,"Fast Tzom Gedaliah NH",None,"7:17 PM","NH","5:15 AM"),
    ("Sep",26,2025,"Vayeilech","6:23","7:21","NH"),("Oct",1,2025,"Yom Kippur","6:15","7:12","NH"),
    ("Oct",3,2025,"Ha'azinu","6:11","7:09","NH"),("Oct",6,2025,"Sukkos","6:06",None,"NH"),
    ("Oct",7,2025,"Sukkos","7:04","7:02","NH"),("Oct",10,2025,"Sukkos","6:00","6:58","NH"),("Oct",13,2025,"Shmini Atzeres","5:55",None,"NH"),
    ("Oct",14,2025,"Simchas Torah","6:53","6:51","NH"),("Oct",17,2025,"Bereshis","5:49","6:47","NH"),("Oct",24,2025,"Noach","5:39","6:37","NH"),
    ("Oct",31,2025,"Lech-Lecha","5:29","6:29","NH"),("Nov",7,2025,"Vayera","4:21","5:22","NH"),("Nov",14,2025,"Chayei Sara","4:14","5:16","NH"),
    ("Nov",21,2025,"Toldos","4:09","5:11","NH"),("Nov",28,2025,"Vayetzei","4:06","5:09","NH"),("Dec",5,2025,"Vayishlach","4:04","5:08","NH"),
    ("Dec",12,2025,"Vayeshev","4:04","5:09","NH"),("Dec",19,2025,"Miketz","4:06","5:11","NH"),("Dec",26,2025,"Vayigash","4:10","5:15","NH"),
    ("Dec",30,2025,"Fast Asara B'Teves NH",None,"5:09 PM","NH","5:48 AM"),
    ("Jan",2,2026,"Vayechi","4:16","5:21","NH"),("Jan",9,2026,"Shemos","4:22","5:27","NH"),("Jan",16,2026,"Vaera","4:30","5:34","NH"),
    ("Jan",23,2026,"Bo","4:38","5:42","NH"),("Jan",30,2026,"Beshalach","4:47","5:50","NH"),("Feb",6,2026,"Yisro","4:56","5:58","NH"),
    ("Feb",13,2026,"Mishpatim","5:05","6:06","NH"),("Feb",20,2026,"Terumah","5:13","6:15","NH"),("Feb",27,2026,"Tetzaveh","5:22","6:23","NH"),
    ("Mar",2,2026,"Fast Taanis Esther NH",None,"6:17 PM","NH","5:03 AM"),
    ("Mar",6,2026,"Ki Sisa","5:30","6:30","NH"),("Mar",13,2026,"Vayakhel-Pekudei","6:38","7:38","NH"),("Mar",20,2026,"Vayikra","6:45","7:46","NH"),
    ("Mar",27,2026,"Tzav","6:53","7:54","NH"),
    ("Apr",1,2026,"Fast Taanis Bechoros NH",None,None,"NH","5:11 AM"),
    ("Apr",1,2026,"Pesach","6:58",None,"NH"),("Apr",2,2026,"Pesach","8:00",None,"NH"),
    ("Apr",3,2026,"Pesach","7:01","8:02","NH"),("Apr",7,2026,"Pesach","7:05",None,"NH"),("Apr",8,2026,"Pesach","8:07","8:08","NH"),
    ("Apr",10,2026,"Shmini","7:08","8:10","NH"),("Apr",17,2026,"Tazria-Metzora","7:16","8:19","NH"),("Apr",24,2026,"Achrei Mos-Kedoshim","7:23","8:27","NH"),
    ("May",1,2026,"Emor","7:31","8:36","NH"),("May",8,2026,"Behar-Bechukosai","7:38","8:44","NH"),("May",15,2026,"Bamidbar","7:45","8:52","NH"),
    ("May",21,2026,"Shavuos","7:51",None,"NH"),("May",22,2026,"Shavuos","7:52","9:00","NH"),("May",29,2026,"Nasso","7:58","9:07","NH"),
    ("Jun",5,2026,"Beha'aloscha","8:03","9:13","NH"),("Jun",12,2026,"Sh'lach","8:07","9:17","NH"),("Jun",19,2026,"Korach","8:10","9:20","NH"),
    ("Jun",26,2026,"Chukas-Balak","8:11","9:20","NH"),
    ("Jul",2,2026,"Fast Tzom Tammuz NH",None,"9:10 PM","NH","3:33 AM"),
    ("Jul",3,2026,"Pinchas","8:10","9:19","NH"),("Jul",10,2026,"Matos-Masei","8:08","9:15","NH"),
    ("Jul",17,2026,"Devarim","8:04","9:10","NH"),
    ("Jul",22,2026,"Fast Tisha B'Av NH Start",None,None,"NH","8:18 PM"),
    ("Jul",23,2026,"Fast Tisha B'Av NH End",None,"8:56 PM","NH"),
    ("Jul",24,2026,"Vaeschanan","7:58","9:03","NH"),("Jul",31,2026,"Eikev","7:51","8:55","NH"),
    ("Aug",7,2026,"Re'eh","7:43","8:46","NH"),("Aug",14,2026,"Shoftim","7:34","8:35","NH"),("Aug",21,2026,"Ki Seitzei","7:23","8:24","NH"),
    ("Aug",28,2026,"Ki Savo","7:12","8:12","NH")
]
# --- END OF HARDCODED DATA ---

processed_hardcoded_cl_hav = collections.defaultdict(list)
hardcoded_saturday_parsha_names = {}
month_map_abbr_to_num = {"Jan":1,"Feb":2,"Mar":3,"Apr":4,"May":5,"Jun":6,"Jul":7,"Aug":8,"Sep":9,"Oct":10,"Nov":11,"Dec":12}

yom_tov_havdalah_next_day_override_dates = {
    "2025-09-23", "2025-10-01", "2025-10-07", "2025-10-14",
    "2026-04-02", "2026-04-08", "2026-05-22"
}

for entry_tuple in hardcoded_cl_hav_data_raw_tuples:
    month_abbr, day, year_val, parsha_context, cl_time_str, hav_time_str, loc_abbrev, *fast_begin_time_opt = entry_tuple
    fast_begin_time_str = fast_begin_time_opt[0] if fast_begin_time_opt else None
    month_num = month_map_abbr_to_num[month_abbr]
    try:
        date_obj = datetime(year_val, month_num, day)
        date_str_key = date_obj.strftime("%Y-%m-%d")
        
        if cl_time_str:
            processed_hardcoded_cl_hav[date_str_key].append((loc_abbrev, "CL", f"{cl_time_str} PM"))
        
        if hav_time_str:
            hav_date_to_use_for_storage = date_obj
            event_type = "Hav"
            if "Fast" in parsha_context and ("End" in parsha_context or \
                                            any(ftd_keyword in parsha_context for ftd_keyword in ["Tzom", "Asara", "Ta'anis"]) and "Start" not in parsha_context) :
                 event_type = "Fast Ends"

            if date_str_key in yom_tov_havdalah_next_day_override_dates and event_type == "Hav":
                hav_date_to_use_for_storage = date_obj + timedelta(days=1)
            elif date_obj.weekday() == 4 and cl_time_str and event_type == "Hav": 
                hav_date_to_use_for_storage = date_obj + timedelta(days=1)
            
            hav_date_str_key_final = hav_date_to_use_for_storage.strftime("%Y-%m-%d")
            time_to_store = hav_time_str
            if " AM" not in hav_time_str.upper() and " PM" not in hav_time_str.upper():
                time_to_store += " PM"
            processed_hardcoded_cl_hav[hav_date_str_key_final].append((loc_abbrev, event_type, time_to_store))

        if fast_begin_time_str:
            time_to_store = fast_begin_time_str
            event_type = "Fast Begins" 
            if "AM" not in fast_begin_time_str.upper() and "PM" not in fast_begin_time_str.upper():
                try:
                    h = int(fast_begin_time_str.split(":")[0])
                    if h < 12 : time_to_store += " AM" 
                    else: time_to_store += " PM" 
                except: time_to_store += " AM" 
            
            if "Start" in parsha_context and "PM" in time_to_store.upper():
                 event_type = "Fast Starts PM"
            
            processed_hardcoded_cl_hav[date_str_key].append((loc_abbrev, event_type, time_to_store))

        if parsha_context and not any(keyword.lower() in parsha_context.lower() for keyword in MAJOR_HOLIDAY_KEYWORDS + ["Shmini", "Simchas Torah", "Fast"]):
            saturday_date_obj = date_obj
            if date_obj.weekday() == 4: saturday_date_obj = date_obj + timedelta(days=1)
            if saturday_date_obj.weekday() == 5:
                hardcoded_saturday_parsha_names[saturday_date_obj.strftime("%Y-%m-%d")] = parsha_context
    except ValueError as e: print(f"Err hardcode: {month_abbr}{day},{year_val} for {loc_abbrev}. {e}")

sept_2025_hebrew_dates_override = {
    "2025-09-01": "8 Elul", "2025-09-02": "9 Elul", "2025-09-03": "10 Elul",
    "2025-09-04": "11 Elul", "2025-09-05": "12 Elul", "2025-09-06": "13 Elul",
    "2025-09-07": "14 Elul", "2025-09-08": "15 Elul", "2025-09-09": "16 Elul",
    "2025-09-10": "17 Elul", "2025-09-11": "18 Elul", "2025-09-12": "19 Elul",
    "2025-09-13": "20 Elul", "2025-09-14": "21 Elul", "2025-09-15": "22 Elul",
    "2025-09-16": "23 Elul", "2025-09-17": "24 Elul", "2025-09-18": "25 Elul",
    "2025-09-19": "26 Elul", "2025-09-20": "27 Elul", "2025-09-21": "28 Elul",
    "2025-09-22": "29 Elul",
}

def parse_csv_data(filename="hebcal_2025_kingston_usa.csv"):
    events = collections.defaultdict(list)
    rosh_chodesh_entries = []
    timed_cl_hav_events = collections.defaultdict(list) 
    for date_key, times_list_of_tuples in processed_hardcoded_cl_hav.items():
        timed_cl_hav_events[date_key].extend(times_list_of_tuples)
    try:
        with open(filename, 'r', encoding='utf-8-sig') as f:
            reader = csv.DictReader(f)
            for row in reader:
                try:
                    subject, start_date_str = row.get("Subject"), row.get("Start Date")
                    if not subject or not start_date_str: continue
                    date_obj = datetime.strptime(start_date_str, "%m/%d/%Y")
                    date_str_key = date_obj.strftime("%Y-%m-%d")
                    is_all_day = row.get("All day event", "true").lower() == "true"
                    process_as_general_event = True
                    if not is_all_day and row.get("Start Time") and row.get("Location"):
                        csv_loc_lower = row.get("Location").lower()
                        if "candle lighting" in subject.lower() or "havdalah" in subject.lower() or "fast begins" in subject.lower() or "fast ends" in subject.lower() :
                            if any(loc_key.lower() in csv_loc_lower for loc_key in ["kingston", "new york", "brooklyn", "philadelphia", "phoenix", "arizona", "new haven"]):
                                process_as_general_event = False 
                    if process_as_general_event and subject.strip():
                         events[date_str_key].append(subject)
                    hm_to_add = None
                    if "Rosh Chodesh" in subject: hm_to_add = subject.split("Rosh Chodesh ", 1)[-1].strip()
                    elif "ראש חודש" in subject: heb_m = subject.split("ראש חודש ", 1)[-1].strip(); hm_to_add = hebrew_to_english_month_map_global.get(heb_m, heb_m)
                    elif "Erev Rosh Hashana" in subject or "ערב ראש השנה" in subject: hm_to_add = "Tishrei"
                    elif subject.startswith("Rosh Hashana 57") or subject.startswith("ראש השנה 57"): hm_to_add = "Tishrei"
                    if hm_to_add and hm_to_add in get_hebrew_month_cycle(): rosh_chodesh_entries.append((date_obj, hm_to_add))
                except Exception as e: print(f"Error CSV row {row}: {e}")
    except FileNotFoundError: print(f"Err: CSV '{filename}' not found."); return events, rosh_chodesh_entries, timed_cl_hav_events
    rosh_chodesh_entries.sort(key=lambda x: x[0])
    for date_key in timed_cl_hav_events: timed_cl_hav_events[date_key] = sorted(list(set(timed_cl_hav_events[date_key])))
    return events, rosh_chodesh_entries, timed_cl_hav_events

def get_hebrew_month_cycle(): return ["Tishrei","Cheshvan","Kislev","Teves","Sh’vat","Adar","Adar I","Adar II","Nisan","Iyar","Sivan","Tamuz","Av","Elul"]

def get_previous_hebrew_month(current_month_name, year_months):
    std_cycle = get_hebrew_month_cycle()
    try:
        idx = year_months.index(current_month_name)
        if idx > 0: return year_months[idx-1]
        else:
            gen_idx = std_cycle.index(current_month_name)
            if current_month_name=="Nisan":
                if "Adar II" in year_months: return "Adar II"
                if "Adar" in year_months: return "Adar"
            if current_month_name=="Adar II": return "Adar I"
            return std_cycle[gen_idx-1] if gen_idx > 0 else std_cycle[-1]
    except ValueError: return "UnknownPrev"
    return "ErrorInPrev"

def build_hebrew_date_map(rosh_chodesh_entries):
    g_to_h_map = {} 
    yearly_months = collections.defaultdict(list)
    if rosh_chodesh_entries:
        for date_obj, hm_name in rosh_chodesh_entries:
            if hm_name not in yearly_months[date_obj.year]: yearly_months[date_obj.year].append(hm_name)
        std_cycle = get_hebrew_month_cycle()
        for year_val in yearly_months: yearly_months[year_val].sort(key=lambda m: std_cycle.index(m) if m in std_cycle else -1)
        ptr = 0
        while ptr < len(rosh_chodesh_entries):
            rc_date, hm_eng = rosh_chodesh_entries[ptr]; actual_start_greg = rc_date
            if ptr + 1 < len(rosh_chodesh_entries) and rosh_chodesh_entries[ptr+1][1] == hm_eng:
                prev_hm_date = rc_date; actual_start_greg = rosh_chodesh_entries[ptr+1][0]
                prev_hm_name = get_previous_hebrew_month(hm_eng, yearly_months.get(prev_hm_date.year, std_cycle))
                if not (prev_hm_date.strftime("%Y-%m") == "2025-09" and prev_hm_date.strftime("%Y-%m-%d") in sept_2025_hebrew_dates_override):
                    g_to_h_map[prev_hm_date.strftime('%Y-%m-%d')] = f"30 {prev_hm_name}"
                ptr += 1
            
            next_hm_start_greg = (rosh_chodesh_entries[ptr+1][0] if ptr + 1 < len(rosh_chodesh_entries) else actual_start_greg + timedelta(days=32))
            if ptr + 1 < len(rosh_chodesh_entries) and ptr + 2 < len(rosh_chodesh_entries) and \
               rosh_chodesh_entries[ptr+1][1] == rosh_chodesh_entries[ptr+2][1]:
                 next_hm_start_greg = rosh_chodesh_entries[ptr+1][0]

            day_in_hm = 1; iter_greg_date = actual_start_greg
            while iter_greg_date < next_hm_start_greg:
                date_str = iter_greg_date.strftime('%Y-%m-%d')
                if not (date_str in sept_2025_hebrew_dates_override and iter_greg_date.strftime("%Y-%m") == "2025-09"):
                    if date_str not in g_to_h_map or not g_to_h_map[date_str].startswith("30 "):
                        g_to_h_map[date_str] = f"{day_in_hm} {hm_eng}"
                iter_greg_date += timedelta(days=1); day_in_hm += 1
            ptr += 1
            
    for greg_date_str, heb_date_eng_str in sept_2025_hebrew_dates_override.items():
        is_already_tishrei = False
        if greg_date_str in g_to_h_map and "Tishrei" in g_to_h_map[greg_date_str]:
            is_already_tishrei = True
        if not is_already_tishrei : 
            g_to_h_map[greg_date_str] = heb_date_eng_str
    return g_to_h_map

def is_hebrew_date_event(event_subject, mapped_hebrew_date_english):
    if not mapped_hebrew_date_english or not event_subject: return False
    try: m_day_str, m_month_english = mapped_hebrew_date_english.split(" ", 1)
    except ValueError: return False
    p1 = rf"^\s*{re.escape(m_day_str)}(?:st|nd|rd|th)?\s+of\s+{re.escape(m_month_english)}(?:\s+57\d{{2}})?\s*$"
    p2 = rf"^\s*{re.escape(m_day_str)}\s+{re.escape(m_month_english)}(?:\s+57\d{{2}})?\s*$"
    return bool(re.fullmatch(p1, event_subject.strip(), re.IGNORECASE) or re.fullmatch(p2, event_subject.strip(), re.IGNORECASE))

def generate_month_html(year, month_num, events_data, hebrew_date_map, timed_cl_hav_data):
    month_name_gregorian = datetime(year, month_num, 1).strftime("%B")
    html = f"<h2>{month_name_gregorian} {year}</h2>\n<table class='calendar'>\n<thead><tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr></thead>\n<tbody>\n"
    first_day = datetime(year, month_num, 1); start_wd = (first_day.weekday() + 1) % 7
    days_in_month = (datetime(year + (1 if month_num == 12 else 0), (1 if month_num == 12 else month_num + 1), 1) - timedelta(days=1)).day
    curr_day = 1; html += "<tr>"; [html := html + "<td class='empty'></td>" for _ in range(start_wd)]; day_of_wk_cnt = start_wd
    while curr_day <= days_in_month:
        if day_of_wk_cnt == 7: html += "</tr>\n<tr>"; day_of_wk_cnt = 0
        date_obj = datetime(year, month_num, curr_day); date_key = date_obj.strftime("%Y-%m-%d"); greg_day = str(curr_day); wd = date_obj.weekday()
        heb_map_val = hebrew_date_map.get(date_key, ""); heb_disp = " "
        if heb_map_val:
            parts = heb_map_val.split(" ",1)
            if len(parts)==2: 
                day_s, mon_e = parts
                try: heb_disp = f"{to_hebrew_numeral(int(day_s))} {english_to_hebrew_month_map_global.get(mon_e,mon_e)}"
                except ValueError: heb_disp = heb_map_val 
            else: heb_disp = heb_map_val
        
        evt_html = ""; is_holiday_bg = False; parsha_name_eng = ""
        bottom_left_holiday_list = []
        
        birthday_messages_for_day = []
        if date_key == "2025-09-15": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Sarah!</div>")
        if date_key == "2025-09-13": birthday_messages_for_day.append("<div class='birthday-message'>Happy Anniversary Sara & Leib!</div>")
        if date_key == "2025-09-04": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Chaim!</div>")
        if date_key == "2025-09-05": birthday_messages_for_day.append("<div class='birthday-message'>Yahrtzeit Aunt Annie</div>")
        if date_key == "2025-09-03": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Mimi!</div>")
        if date_key == "2025-09-27": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Rivky!</div>")
        if date_key == "2025-10-19": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Shaya!</div>")
        if date_key == "2025-10-11": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Levi!</div>")
        if date_key == "2025-10-09": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Zaidy Borsock!</div>")
        if date_key == "2025-10-13": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Gisa!</div>")
        if date_key == "2025-11-04": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Matty!</div>")
        if date_key == "2025-11-08": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Zalman!</div>")
        if date_key == "2025-11-17": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Gila!</div>")
        if date_key == "2025-10-31": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Sarah!</div>") 
        if date_key == "2025-11-03": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Gisa!</div>")
        if date_key == "2025-11-19": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Mimi!</div>")
        if date_key == "2025-10-29": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Shaindy!</div>")
        if date_key == "2025-11-21": 
            birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Yaakov!</div>")
            birthday_messages_for_day.append("<div class='birthday-message birthday-message-left'>Happy Birthday<br>Mindy!</div>")
        if date_key == "2025-12-28": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Yehuda!</div>")
        if date_key == "2026-01-06": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Mendy!</div>")
        if date_key == "2025-12-26": birthday_messages_for_day.append("<div class='birthday-message'>Happy Birthday Chanie!</div>")
        if date_key == "2026-02-02": birthday_messages_for_day.append("<div class='birthday-message'>Happy Anniversary Yossi & Gila!</div>")
        
        birthday_message_html = "".join(birthday_messages_for_day)


        day_evts = events_data.get(date_key, [])
        if wd == 5: parsha_name_eng = hardcoded_saturday_parsha_names.get(date_key, "")
        
        # Special handling for specific holidays to go to bottom-left, BEFORE general event processing
        if date_key == "2025-11-21": 
            temp_day_evts = []
            rc_moved = False
            for e_subj_check in day_evts:
                if "rosh chodesh kislev" in e_subj_check.lower() and not rc_moved:
                    if "Rosh Chodesh Kislev" not in bottom_left_holiday_list: bottom_left_holiday_list.append("Rosh Chodesh Kislev")
                    is_holiday_bg = True; rc_moved = True
                else: temp_day_evts.append(e_subj_check)
            day_evts = temp_day_evts
        elif date_key == "2026-02-02": 
            temp_day_evts = []
            tu_bshvat_moved = False
            for e_subj_check in day_evts:
                if "tu bishvat" in e_subj_check.lower() and not tu_bshvat_moved:
                    if "Tu BiShvat" not in bottom_left_holiday_list: bottom_left_holiday_list.append("Tu BiShvat")
                    is_holiday_bg = True; tu_bshvat_moved = True
                else: temp_day_evts.append(e_subj_check)
            day_evts = temp_day_evts

        for e_subj in day_evts:
            e_s = e_subj.strip()
            if not e_s or is_hebrew_date_event(e_s, heb_map_val): continue
            if parsha_name_eng and e_s.lower() == parsha_name_eng.lower(): continue
            if wd == 5 and not parsha_name_eng:
                if any(p.lower() == e_s.lower() for p in english_to_hebrew_parsha_map.keys()):
                    parsha_name_eng = e_s; continue
            
            if date_key == "2026-04-01" and e_s.lower() == "erev pesach": continue
            if "yizkor" in e_s.lower(): continue
            if e_s.lower() == "chag habanot" or e_s.lower() == "chag ha'banot": continue
            if e_s.lower() == "rosh hashana labehemot" or e_s.lower() == "rosh hashana la'behemot": continue

            is_fast_day_event = any(fd_key.lower() in e_s.lower() for fd_key in FAST_DAY_KEYWORDS)
            is_major_holiday_event = any(mh_key.lower() in e_s.lower() for mh_key in MAJOR_HOLIDAY_KEYWORDS)
            is_special_shabbos = wd == 5 and any(ss_name.lower() == e_s.lower() for ss_name in SPECIAL_SHABBOS_NAMES)

            # Handle Rosh Chodesh separately for bottom-left if not already moved (e.g. Nov 21)
            if "rosh chodesh" in e_s.lower() and not is_fast_day_event and e_s not in bottom_left_holiday_list:
                 if e_s not in bottom_left_holiday_list: bottom_left_holiday_list.append(e_s)
                 is_holiday_bg = True
            elif (is_major_holiday_event and not is_fast_day_event) or is_special_shabbos:
                formatted_holiday_name = format_holiday_name(e_s)
                if formatted_holiday_name not in bottom_left_holiday_list:
                    bottom_left_holiday_list.append(formatted_holiday_name)
                is_holiday_bg = True
            else: 
                evt_html += f"<div class='event'>{e_subj}</div>"
                if is_major_holiday_event : is_holiday_bg = True
        
        bottom_left_holiday_disp_html = ""
        if bottom_left_holiday_list:
            bottom_left_holiday_disp_html = "<div class='bottom-left-holiday-container'>" + "<br>".join(list(dict.fromkeys(bottom_left_holiday_list))) + "</div>"

        parsha_name_heb = english_to_hebrew_parsha_map.get(parsha_name_eng, parsha_name_eng if parsha_name_eng else "")
        top_line_parsha_html = f"<span class='top-line-parsha'>{parsha_name_heb}</span>" if parsha_name_eng else "<span class='top-line-parsha'> </span>"
        
        am_times_styled = []
        pm_times_styled = []
        all_timed_tuples = timed_cl_hav_data.get(date_key, [])
        
        for loc_abbrev, event_type, time_only_str in sorted(list(set(all_timed_tuples))):
            loc_class = "cl-hav-item"
            if loc_abbrev == "NY": loc_class += " cl-hav-ny"
            elif loc_abbrev == "PA": loc_class += " cl-hav-pa"
            elif loc_abbrev == "AZ": loc_class += " cl-hav-az"
            elif loc_abbrev == "NH": loc_class += " cl-hav-nh"
            elif loc_abbrev == "LA": loc_class += " cl-hav-la"

            if date_key == "2026-07-22": 
                pm_times_styled.append(f"<span class='{loc_class}'>{time_only_str}</span>")
            elif event_type == "Fast Begins":
                 am_times_styled.append(f"<span class='{loc_class}'>{time_only_str}</span>")
            elif event_type == "Fast Starts PM": 
                 pm_times_styled.append(f"<span class='{loc_class}'>{time_only_str}</span>")
            elif wd == 4 and event_type == "CL": 
                pm_times_styled.append(f"<span class='{loc_class}'>{time_only_str}</span>")
            elif wd == 5 and event_type == "Hav": 
                pm_times_styled.append(f"<span class='{loc_class}'>{time_only_str}</span>")
            elif wd != 4 and wd != 5: 
                if event_type in ["CL", "Hav", "Fast Ends"]: 
                     pm_times_styled.append(f"<span class='{loc_class}'>{time_only_str}</span>")
        
        am_disp_html = "<br>".join(am_times_styled)
        pm_disp_html = "<br>".join(pm_times_styled)
        
        cell_cls = " class='special-day-background'" if wd == 5 or is_holiday_bg else ""
        html += f"""
        <td{cell_cls}>
            <div class='top-info-line'>
                <span class='gregorian-date-top'>{greg_day}</span>
                {top_line_parsha_html}
                <span class='hebrew-date-top'>{heb_disp}</span>
            </div>
            {birthday_message_html}
            <div class='events-container'>
                {evt_html}
            </div>
            {bottom_left_holiday_disp_html}
            <div class='am-times-container'>{am_disp_html}</div>
            <div class='cl-hav-container'>{pm_disp_html}</div>
        </td>"""
        curr_day += 1; day_of_wk_cnt += 1
    while day_of_wk_cnt < 7 and day_of_wk_cnt != 0: html += "<td class='empty'></td>"; day_of_wk_cnt += 1
    html += "</tr>\n</tbody>\n</table>\n" 
    return html

def get_year_month_range(events_data, rosh_chodesh_entries):
    all_dates = []
    if events_data: all_dates.extend([datetime.strptime(d, "%Y-%m-%d") for d in events_data.keys()])
    if rosh_chodesh_entries: all_dates.extend([rc[0] for rc in rosh_chodesh_entries])
    calendar_start_year, calendar_start_month = 2025, 9
    end_year_limit, end_month_limit = 2026, 8 
    if not all_dates:
        now = datetime.now()
        if (now.year > calendar_start_year or (now.year == calendar_start_year and now.month >= calendar_start_month)) and \
           (now.year < end_year_limit or (now.year == end_year_limit and now.month <= end_month_limit)):
            return [(now.year, now.month)]
        return []
    min_data_date = min(all_dates); max_data_date = max(all_dates)
    iter_start_year, iter_start_month = calendar_start_year, calendar_start_month
    if min_data_date.year > calendar_start_year or \
       (min_data_date.year == calendar_start_year and min_data_date.month > calendar_start_month):
        iter_start_year, iter_start_month = min_data_date.year, min_data_date.month
    current_year, current_month = iter_start_year, iter_start_month; yms = []
    while True:
        if current_year > end_year_limit or (current_year == end_year_limit and current_month > end_month_limit): break
        # Check if current iteration point is past the actual data available, if data ends before hard limit
        if current_year > max_data_date.year or \
           (current_year == max_data_date.year and current_month > max_data_date.month and not \
            (current_year == end_year_limit and current_month <= end_month_limit) ): # Ensure we don't stop early if max_data is before limit but we haven't reached limit
            break

        yms.append((current_year, current_month))
        
        # Termination condition if we have reached the absolute maximum date from data,
        # and it's before or at the hard limit.
        if current_year == max_data_date.year and current_month == max_data_date.month and \
           (current_year < end_year_limit or (current_year == end_year_limit and current_month <= end_month_limit)):
            break

        current_month += 1
        if current_month > 12: current_month = 1; current_year += 1
    return yms

def main():
    csv_filename = "hebcal_2025_kingston_usa.csv" 
    events_data, rosh_chodesh_entries, timed_cl_hav_data = parse_csv_data(csv_filename)
    hebrew_date_map = build_hebrew_date_map(rosh_chodesh_entries)
    year_month_list = get_year_month_range(events_data, rosh_chodesh_entries)
    html_title = "לוח שנה עברי - לועזי"
    if year_month_list:
        s_year, e_year = year_month_list[0][0], year_month_list[-1][0]
        year_range = f"({s_year})" if s_year == e_year else f"({s_year}–{e_year})"
        html_title += f" {year_range}"
    else: html_title += " (No data in selected range)"

    all_calendar_html_content = ""
    if not year_month_list:
        all_calendar_html_content = "<p>No calendar data to display for the selected range.</p>"
    else:
        for i, (year, month_val) in enumerate(year_month_list):
            all_calendar_html_content += generate_month_html(year, month_val, events_data, hebrew_date_map, timed_cl_hav_data)
            all_calendar_html_content += """
            <div class="info-bar">
                <div class="info-bar-locations">
                    <span class="info-loc-item cl-hav-az">Arizona</span>
                    <span class="info-loc-item cl-hav-nh">New Haven</span>
                    <span class="info-loc-item cl-hav-ny">New York</span>
                    <span class="info-loc-item cl-hav-pa">Pennsylvania</span>
                </div>
                <div class="info-bar-center">All halachic times are from hebcal.com</div>
                <div class="info-bar-right">Made by Eli Roitblat</div>
            </div>
            <hr/>
            """
            
    all_calendar_html = f"""
<!DOCTYPE html><html lang="he"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<title>{html_title}</title><style>
body {{ font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; margin:20px; background-color:#f4f4f4; color:#333; }}
h1 {{ text-align:center; color:#2c3e50; }} h2 {{ text-align:center; color:#34495e; margin-top:30px; }}
.calendar {{ width:100%; border-collapse:collapse; margin-bottom:0; box-shadow:0 0 10px rgba(0,0,0,0.1); background-color:#fff; }}
.calendar th, .calendar td {{ 
    border:1px solid #ddd; padding:0; text-align:left; vertical-align:top; 
    height:140px; width:14.28%; position:relative; 
}}
.calendar th {{ background-color:#b6225e; color:white; text-align:center; padding:3px; height:auto;}}
.calendar td.empty {{ background-color:#fff; }}
.special-day-background {{ background: linear-gradient(to bottom, rgba(179,131,115,0.35) 0%, rgba(179,131,115,0.25) 100%) !important; }}

.top-info-line {{ 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 2px 3px; margin-bottom: 1px; 
}}
.gregorian-date-top {{ color:black; font-weight:bold; font-size:1.1em; flex-shrink: 0; padding-left: 2px;}}
.top-line-parsha {{ font-size:0.8em; font-weight:bold; text-align:center; color:#444; flex-grow: 1; margin: 0 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}}
.hebrew-date-top {{ color:blue; font-weight:bold; font-size:0.9em; direction:rtl; flex-shrink: 0; padding-right: 2px;}}

.birthday-message {{
    font-family: 'Pacifico', cursive; color: #C71585; font-size: 0.9em;
    text-align: center; padding: 1px 0; 
}}
.birthday-message-left {{ text-align: left !important; padding-left: 5px !important; }}

.events-container {{ 
    font-size:0.7em; line-height:1.15; overflow-y:auto; padding:1px 3px; 
    max-height:calc(100% - 100px); 
    margin-bottom:30px; 
}}
.event {{ background-color:#e9f5ff; border-left:3px solid #3498db; padding:1px 3px; margin-bottom:1px; border-radius:3px; color:#2c3e50; word-wrap:break-word; }}

.bottom-left-holiday-container {{
    position:absolute; bottom:2px; left:3px; 
    font-size:0.8em; 
    font-weight: bold; 
    line-height:1.15; text-align:left; padding:1px 2px;
    color: #2c3e50; 
    max-width: 50%; 
    z-index: 3; 
}}
.am-times-container {{
    position:absolute; bottom:2px; left:3px;
    font-size:0.7em; line-height:1.15; text-align:left; padding:1px 2px;
    z-index: 2; 
}}
.cl-hav-container {{ 
    position:absolute; bottom:2px; right:3px; 
    font-size:0.7em; line-height:1.15; text-align:right; padding:1px 2px; 
    z-index: 2;
}}
.cl-hav-item {{ display:inline-block; padding: 2px 5px; margin-top: 1px; border-radius:4px; border-left-width: 4px; border-left-style: solid; font-weight: bold; }}
.cl-hav-ny {{ color:white; background-color:#FF8A8A; border-left-color:#D9534F; }}
.cl-hav-pa {{ color:white; background-color:#79B6FF; border-left-color:#4A90E2; }}
.cl-hav-az {{ color:white; background-color:#FFC107; border-left-color:#FFA000; }}
.cl-hav-nh {{ color:white; background-color:#48D1CC; border-left-color:#20B2AA; }}
.cl-hav-la {{ color:white; background-color:#58D68D; border-left-color:#27AE60; }}

.info-bar {{
    width: 100%;
    min-height: 60px; /* Adjusted height */
    height: auto; 
    background-color: #FAFAD2; 
    display: flex;
    justify-content: space-between;
    align-items: center; 
    padding: 3px 10px; /* Adjusted padding */
    box-sizing: border-box;
    margin-top: 0; /* Touches bottom of calendar */
    margin-bottom: 5px;
    font-size: 0.8em; 
}}
.info-bar-locations {{
    display: flex;
    flex-direction: column;
    align-items: flex-start; 
    justify-content: center; 
    max-height: 100%; /* Try to contain within info-bar height */
    overflow: hidden; /* Prevent overflow if too many items */
}}
.info-loc-item {{ 
    padding: 1px 5px; 
    margin-bottom: 1px; 
    border-radius:3px; 
    border-left-width: 3px; border-left-style: solid; font-weight: bold;
    min-width: 90px; 
    text-align: center;
    font-size: 0.85em; 
    line-height: 1.1; /* Adjust line height for tighter packing */
}}
.info-bar-center {{ text-align: center; flex-grow: 1; color: #555; padding: 0 8px; }}
.info-bar-right {{ text-align: right; color: #555; flex-shrink: 0; }}

hr {{ border:0; height:1px; background:#ccc; margin:15px 0; }}
</style></head><body><h1>{html_title}</h1>
{all_calendar_html_content}
</body></html>
"""
    output_filename = "jewish_calendar_final_v19.html" # Incremented filename
    with open(output_filename, "w", encoding='utf-8') as f: f.write(all_calendar_html)
    print(f"Generated {output_filename}")

if __name__ == "__main__":
    main()
# --- END OF FILE import2csv.py ---
